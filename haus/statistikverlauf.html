<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/haus.css">
    <title>Statistik Verlauf</title>
</head>
<body>
    <h1>Aufrufe unserer Seite</h1>
    <table>
        <thead>
            <trow>
                <th>Datum</th>
                <th>Aufrufe</th>
                <th>gemerkt</th>
                <th>&Delta; Tage</th>
                <th>&Delta; Aufrufe</th>
                <th>&Delta; gemerkt</th>
                <th>&#8792; Aufrufe<br>je Woche</th>
                <th>&#8792; gemerkt<br>je Woche</th>
            </trow>
        </thead>
        <tbody>
        </tbody>
    </table>
    <p>Die &Delta;-Spalten zeigen jeweils die Differenz zur Zeile darunter.<br>
    Die Entspricht-Spalten (&#8792;) zeigen Werte, die - bei gleichbleibendem Interesse - 
         in einer ganzen Woche zu erwartenden sind.</p>
    <footer>
      <p><a href= index.html>Hauptseite</a></p>
    </footer>

    <script>
        const REST_READ_URL = "inc/rest_read.php";
         document.addEventListener("DOMContentLoaded", liesDaten);

         function add_td(parent, value) {
             let newElm = document.createElement('td');
             newElm.innerText = value;
             parent.appendChild(newElm);
         }
         async function liesDaten() {
            const start = new Date();
            const response = await fetch(REST_READ_URL + "?action=holeStatistik");
            const data = await response.json();
            const gelesen = new Date();
            // console.log(data);
            if (!data['ok']) {
                alert(data['errmsg']);
            }
            const records = data['result'];
            const container = document.querySelector('tbody');
            const options = {year: 'numeric', month: '2-digit', day: '2-digit'};
            const milliSecJeTag = 1000*3600*24;
            const milliSecJeWoche = milliSecJeTag*7;

            for (let i=0;i<records.length;i++) {
                const record = records[i];
                let newLine = document.createElement('tr');
                const datum = new Date(record['stand']);
                let datstr = datum.toLocaleDateString('de-DE', options);
                datstr += ' ' + datum.toLocaleTimeString('de-DE').slice(0,5);
                add_td(newLine, datstr);
                add_td(newLine, record['aufrufe']);
                add_td(newLine, record['gemerkt']);
                if (i<records.length-1) {
                    const datum2 = new Date(records[i+1]['stand']);
                    const dtime = (datum-datum2)/milliSecJeTag;;
                    add_td(newLine, dtime.toFixed(1) );
                    deltaAufrufe = record['aufrufe']-records[i+1]['aufrufe'];
                    deltaGemerkt = record['gemerkt']-records[i+1]['gemerkt'];
                    add_td(newLine, deltaAufrufe);
                    add_td(newLine, deltaGemerkt);
                    add_td(newLine, (deltaAufrufe/dtime*7).toFixed(0));
                    add_td(newLine, (deltaGemerkt/dtime*7).toFixed(0));
                }
                container.appendChild(newLine);
            }
            const fertig = new Date();
            const ladezeit = gelesen - start;
            const ausgabezeit = fertig - gelesen;
            let newLine = document.createElement('p');
            newLine.innerText = `Ladezeit: ${ladezeit} ms Ausgabezeit: ${ausgabezeit} ms`;
            document.body.appendChild(newLine);

         }
    </script>
</body>
</html>